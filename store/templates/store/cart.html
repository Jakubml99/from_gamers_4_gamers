{% extends 'store/base.html' %}

{% block title %}Cart{% endblock %}

{% block content %}
<h1 class="my-4">Shopping Cart</h1>
{% if order %}
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="cart-items">
            {% for item in order.items.all %}
            <tr data-item-id="{{ item.id }}">
                <td>{{ item.product.name }}</td>
                <td class="item-price">${{ item.price }}</td>
                <td>
                    <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="form-control d-inline-block w-25 quantity-input" data-item-id="{{ item.id }}">
                </td>
                <td class="item-total">${{ item.get_cost }}</td>
                <td>
                    <form method="post" class="delete-form" action="{% url 'store:delete_from_cart' item.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h3>Total: $<span id="cart-total">{{ order.get_total_cost }}</span></h3>
    <a href="{% url 'store:checkout' %}" class="btn btn-success">Proceed to Checkout</a>
{% else %}
    <p>Your cart is empty.</p>
{% endif %}

<script>
    // Function to update the total cost for an item
    function updateItemTotal(itemId, quantity, price) {
        const itemTotalElement = document.querySelector(`tr[data-item-id="${itemId}"] .item-total`);
        const total = (quantity * price).toFixed(2);
        itemTotalElement.textContent = `$${total}`;
    }

    // Function to update the overall cart total
    function updateCartTotal() {
        let total = 0;
        document.querySelectorAll('.item-total').forEach(function(itemTotalElement) {
            total += parseFloat(itemTotalElement.textContent.replace('$', ''));
        });
        document.getElementById('cart-total').textContent = total.toFixed(2);
    }

    // Event listener for quantity changes
    document.querySelectorAll('.quantity-input').forEach(function(input) {
        input.addEventListener('change', function() {
            const itemId = this.dataset['itemId'];
            const quantity = this.value;
            const price = parseFloat(document.querySelector(`tr[data-item-id="${itemId}"] .item-price`).textContent.replace('$', ''));

            // Update the item's total
            updateItemTotal(itemId, quantity, price);

            // Update the cart's total
            updateCartTotal();

            // Optionally, you can send the update to the server using AJAX (not covered in this snippet)
        });
    });

    // Event listener for delete buttons
    document.querySelectorAll('.delete-form').forEach(function(form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const itemId = form.closest('tr').dataset['itemId'];
            form.closest('tr').remove();
            updateCartTotal();

            // Optionally, you can send the delete request to the server using AJAX (not covered in this snippet)
        });
    });
</script>

{% endblock %}
